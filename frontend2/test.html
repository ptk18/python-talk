<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Voice Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        display: flex;
        height: 100vh;
      }

      /* Left side (Chat) */
      #left {
        width: 50%;
        padding: 20px;
        border-right: 2px solid #ccc;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      /* Right side (Code Display) */
      #right {
        width: 50%;
        padding: 20px;
        box-sizing: border-box;
        background: #f9f9f9;
      }

      #chat {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 400px;
        max-height: 70vh;
        overflow-y: auto;
        margin-bottom: 10px;
      }

      #textInputContainer {
        display: flex;
        margin-top: 10px;
      }

      #textInputContainer input {
        flex: 1;
        padding: 8px;
        font-size: 14px;
      }

      #textInputContainer button {
        padding: 8px 12px;
        margin-left: 5px;
        font-size: 14px;
        cursor: pointer;
      }

      .you {
        color: blue;
      }
      .system {
        color: green;
        margin-left: 20px;
      }
      .alternatives {
        color: purple;
        margin-left: 40px;
        font-style: italic;
      }
      .original {
        color: gray;
        margin-left: 40px;
        font-style: italic;
      }

      #codeBox {
        width: 100%;
        height: 80vh;
        white-space: pre;
        overflow-y: auto;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        padding: 10px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <!-- LEFT SIDE: Chat -->
    <div id="left">
      <div>
        <h2>Voice Interaction</h2>
        <!-- Language dropdown -->
        <select id="languageSelect">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="th">Thai</option>
        </select>
        <button id="recordBtn">Start Recording</button>

        <div id="chat"></div>
      </div>

      <!-- Text input for typing -->
      <div id="textInputContainer">
        <input type="text" id="typedMessage" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <!-- RIGHT SIDE: Code Display -->
    <div id="right">
      <h2 id="fileName">Loading file...</h2>
      <div id="codeBox">Fetching code...</div>
    </div>

    <script>
const recordBtn = document.getElementById("recordBtn");
const chat = document.getElementById("chat");
const languageSelect = document.getElementById("languageSelect");
const typedMessage = document.getElementById("typedMessage");
const sendBtn = document.getElementById("sendBtn");
const urlParams = new URLSearchParams(window.location.search);
const conversationId = urlParams.get("conversationId");

// ------------------- Utility to append messages -------------------
function appendMessage(sender, content) {
  const div = document.createElement("div");
  div.className = sender;
  div.innerHTML = `${sender === "you" ? "You" : "System"} - ${content}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// ------------------- Load previous messages and code -------------------
async function loadConversationCode() {
  try {
    const res = await fetch(`http://127.0.0.1:8000/conversations/${conversationId}/single`);
    const convo = await res.json();
    document.getElementById("fileName").textContent = convo.file_name || "No file name";
    document.getElementById("codeBox").textContent = convo.code || "No code found";
  } catch (err) {
    document.getElementById("codeBox").textContent = "Failed to load code.";
  }
}

async function loadMessages() {
  try {
    const res = await fetch(`http://127.0.0.1:8000/messages/${conversationId}`);
    const msgs = await res.json();
    chat.innerHTML = ""; // clear before loading
    msgs.forEach(m => appendMessage(m.sender === "user" ? "you" : "system", m.content));
  } catch (err) {
    console.error("Failed to load messages:", err);
  }
}

// ------------------- Execute command -------------------
async function executeCommand(executable) {
  try {
    const res = await fetch("http://127.0.0.1:8000/execute_command", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        conversation_id: Number(conversationId),
        executable
      })
    });

    const data = await res.json();
    const output = data.output || "No output";

    appendMessage("system", `Execution Output: ${output}`);

    // Save execution output to backend
    await fetch(
      `http://127.0.0.1:8000/messages/${conversationId}?sender=system&content=${encodeURIComponent("Execution Output: " + output)}`,
      { method: "POST" }
    );

    return output;
  } catch (err) {
    const errorMsg = `Execution failed: ${err.message}`;
    appendMessage("system", errorMsg);
    return errorMsg;
  }
}

// ------------------- Send typed message -------------------
async function sendTypedMessage(text = null) {
  const msg = text || typedMessage.value.trim();
  if (!msg) return;

  if (!text) typedMessage.value = "";

  appendMessage("you", msg);

  // Save user message to backend
  await fetch(
    `http://127.0.0.1:8000/messages/${conversationId}?sender=user&content=${encodeURIComponent(msg)}`,
    { method: "POST" }
  );

  try {
    // Analyze command
    const res = await fetch("http://127.0.0.1:8000/analyze_command", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ conversation_id: Number(conversationId), command: msg })
    });
    const data = await res.json();
    const r = data.result || {};

    const summary = `
"method": "${r.method || "-"}",<br>
"parameters": ${JSON.stringify(r.parameters || {}, null, 2)},<br>
"confidence": ${r.confidence || "-"},<br>
"executable": "${r.executable || "-"}",<br>
"intent_type": "${r.intent_type || "-"}"
`;

    appendMessage("system", summary);

    // Save summary to backend
    await fetch(
      `http://127.0.0.1:8000/messages/${conversationId}?sender=system&content=${encodeURIComponent(summary)}`,
      { method: "POST" }
    );

    // Ask user if they want to execute
    if (r.executable && confirm(`Method found: ${r.executable}. Execute it?`)) {
      await executeCommand(r.executable);
    }

  } catch (err) {
    appendMessage("system", `Error analyzing command: ${err.message}`);
  }
}

// ------------------- Event Listeners -------------------
sendBtn.onclick = () => sendTypedMessage();
typedMessage.addEventListener("keypress", e => { if (e.key === "Enter") sendTypedMessage(); });

// ------------------- Voice Recording Logic -------------------
let mediaRecorder, audioChunks = [];
recordBtn.onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
      const formData = new FormData();
      formData.append("file", audioBlob, "input.webm");
      formData.append("language", languageSelect.value);

      try {
        const res = await fetch("http://127.0.0.1:8000/voice/transcribe", { method: "POST", body: formData });
        const data = await res.json();
        const text = data.text || `[Error: ${data.error || "Unknown"}]`;
        appendMessage("you", text);
        appendMessage("system", `You said: ${text}`);

        // Optionally auto-analyze voice message
        await sendTypedMessage(text);

      } catch (err) {
        appendMessage("system", `Error transcribing voice: ${err.message}`);
      }
    };

    mediaRecorder.start();
    recordBtn.innerText = "Stop Recording";
  } else {
    mediaRecorder.stop();
    recordBtn.innerText = "Start Recording";
  }
};

// ------------------- Initial Load -------------------
window.addEventListener("DOMContentLoaded", () => {
  loadMessages();
  loadConversationCode();
});
</script>


  </body>
</html>
